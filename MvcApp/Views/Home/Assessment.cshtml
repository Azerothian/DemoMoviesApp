<script type="text/x-kendo-tmpl" id="castTemplate">
  <div class="list-group-item">
    <h4 class="list-group-item-heading">#= data #</h4>
    <p class="list-group-item-text">
      <a href="http://www.imdb.com/find?q=#= data #&s=all" class="btn btn-warning pull-right" target="_blank">IMDb</a>
      <div class="clearfix"></div>
    </p>
  </div>
</script>

<div class="row">
  <div class="col-xs-12 ">
    <a href="/Home/CreateNew" class="btn btn-default">Create New</a>
  </div>
</div>
<script>
  var lock = false;
  function getCastByID(id, next) {
    $.ajax({
      type: "GET",
      url: "/Home/GetCastById/" + id,
      success: function (res) {
        next(res);
      }
    });
  }
  function createCastWindow(html, title, next) {
    var castWindow = $(html).kendoWindow({
      width: "450px",
      height: "250px",
      title: title,
      modal: true,
      open: function () {
        next(castWindow);
      },
      close: function () {
        lock = false;
      }
    })
    $(castWindow).data("kendoWindow").center().open();
  }

  function createListView(target, data, next) {
    var ob = $(target).kendoListView({
      dataSource: data.Cast,
      template: kendo.template($("#castTemplate").html())
    });
    ob.append("<div class='clearfix'></div>")
    next(ob);
  }

  function showModal(e) {
    if (lock)
      return
    lock = true;
    var selectedId = $($(this.select()[0]).find("td")[0]).html()
    getCastByID(selectedId, function (data) {
      //console.log("getCastByID", data);
      createCastWindow("<div><div id='castListView' class='list-group'></div></div>", "Cast - " + data.Title, function (win) {
        //console.log("createCastWindow", win);
        var v = $(win).find("#castListView")[0];
        //console.log("found", v)
        createListView(v, data, function (view) {
          //console.log("createListView", view);
        })
      });
    });



  }
</script>
<div class="row">
  <div class="col-xs-12">
    @(Html.Kendo().Grid((IEnumerable<MoviesLibrary.MovieData>)ViewBag.Movies)
    .Name("grid")
    .Columns(columns =>
    {
      columns.Bound(movie => movie.MovieId);
      columns.Bound(movie => movie.Title);
      columns.Bound(movie => movie.ReleaseDate);
      columns.Bound(movie => movie.Rating);
      columns.Bound(movie => movie.Genre);
      columns.Bound(movie => movie.Classification);
    })
    .Pageable()
    .Sortable()
    .DataSource(ds => ds.Server().Model(model => model.Id(p => p.MovieId)))
    .Selectable().Events(e => e.Change(@<text>showModal</text>))
    )

  </div>
</div>
